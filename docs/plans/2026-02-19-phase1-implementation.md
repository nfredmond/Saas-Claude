# OpenPlan Phase 1 — AI Transit Analysis Layer — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a free, open-source web platform where anyone can ask natural-language questions about transit access and equity, answered with live maps powered by real GTFS, Census, and LODES data.

**Architecture:** Next.js 15 App Router monolith on Vercel. Supabase provides Postgres + PostGIS for spatial data, Auth, and Storage. Claude API (via Vercel AI SDK) translates natural-language queries into PostGIS SQL and streams results back. MapLibre GL JS v5 renders the map; deck.gl v9.2 adds H3 and trip layers. Public "Explore" mode requires no login; authenticated workspaces let agencies upload their own GTFS.

**Tech Stack:** Next.js 15, TypeScript, Tailwind CSS v3, shadcn/ui, Supabase (Postgres+PostGIS+Auth+Storage+Edge Functions), MapLibre GL JS v5, deck.gl v9.2, Vercel AI SDK + Claude claude-sonnet-4-6, pnpm

---

## Task 1: Scaffold Next.js 15 project

**Files:**
- Create: `openplan/` (project root)
- Create: `openplan/package.json`, `openplan/next.config.ts`, `openplan/tsconfig.json`
- Create: `openplan/vitest.config.ts`, `openplan/src/test/setup.ts`

**Step 1: Create project**

```bash
cd /c/Users/nfred/code/Saas.Claude
pnpm create next-app@latest openplan --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"
cd openplan
```

**Step 2: Install core dependencies**

```bash
pnpm add @supabase/supabase-js @supabase/ssr
pnpm add maplibre-gl
pnpm add @deck.gl/react @deck.gl/layers @deck.gl/geo-layers @deck.gl/aggregation-layers
pnpm add ai @ai-sdk/anthropic
pnpm add zod
pnpm add lucide-react
pnpm add sonner
pnpm add -D @supabase/cli vitest @vitejs/plugin-react jsdom @testing-library/react @testing-library/jest-dom tsx
```

**Step 3: Install shadcn/ui**

```bash
pnpm dlx shadcn@latest init
# Choose: Default style, Slate base color, CSS variables: yes
pnpm dlx shadcn@latest add button input textarea card badge separator scroll-area tabs toast
```

**Step 4: Create vitest config**

Create `vitest.config.ts`:
```typescript
import { defineConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    globals: true,
  },
  resolve: {
    alias: { '@': path.resolve(__dirname, './src') },
  },
})
```

Create `src/test/setup.ts`:
```typescript
import '@testing-library/jest-dom'
```

Add to `package.json` scripts:
```json
"test": "vitest run",
"test:watch": "vitest",
"seed:gtfs": "tsx scripts/seed-gtfs.ts"
```

**Step 5: Initialize git**

```bash
git init
git add .
git commit -m "chore: scaffold Next.js 15 project with dependencies"
```

Expected: `openplan/` runs on `pnpm dev` at localhost:3000

---

## Task 2: Initialize Supabase and client utilities

**Files:**
- Create: `supabase/` (auto-generated by CLI)
- Create: `.env.local`
- Create: `.env.example`
- Create: `src/lib/supabase/client.ts`
- Create: `src/lib/supabase/server.ts`
- Create: `src/lib/supabase/middleware.ts`
- Create: `src/middleware.ts`

**Step 1: Initialize and start Supabase**

```bash
pnpm supabase init
pnpm supabase start
```

Expected output: URLs and keys printed to console.

**Step 2: Create `.env.local` (not committed)**

```bash
# .env.local — fill in values from `pnpm supabase start` output
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=<anon key>
SUPABASE_SERVICE_ROLE_KEY=<service role key>
ANTHROPIC_API_KEY=<your Anthropic API key from console.anthropic.com>
```

**Step 3: Create `.env.example` (committed)**

```
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
ANTHROPIC_API_KEY=
```

**Step 4: Create `src/lib/supabase/client.ts`**

```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

**Step 5: Create `src/lib/supabase/server.ts`**

```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {}
        },
      },
    }
  )
}
```

**Step 6: Create `src/lib/supabase/middleware.ts`**

```typescript
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({ request })
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return request.cookies.getAll() },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))
          supabaseResponse = NextResponse.next({ request })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )
  await supabase.auth.getUser()
  return supabaseResponse
}
```

**Step 7: Create `src/middleware.ts`**

```typescript
import { type NextRequest } from 'next/server'
import { updateSession } from '@/lib/supabase/middleware'

export async function middleware(request: NextRequest) {
  return await updateSession(request)
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'],
}
```

**Step 8: Commit**

```bash
git add .
git commit -m "chore: add Supabase client utilities and middleware"
```

---

## Task 3: Database schema — GTFS tables

**Files:**
- Create: `supabase/migrations/20260219000001_gtfs_schema.sql`

**Step 1: Write the migration**

```sql
-- Enable extensions
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- GTFS feeds registry (workspace_id NULL = public preloaded feed)
CREATE TABLE gtfs_feeds (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID,  -- FK added after workspaces table exists (Task 4)
  city TEXT,
  state TEXT,
  agency_name TEXT NOT NULL,
  feed_url TEXT,
  status TEXT NOT NULL DEFAULT 'pending',
  loaded_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(city, agency_name)
);

CREATE INDEX idx_gtfs_feeds_workspace ON gtfs_feeds(workspace_id);
CREATE INDEX idx_gtfs_feeds_public ON gtfs_feeds(city, state) WHERE workspace_id IS NULL;

CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feed_id UUID NOT NULL REFERENCES gtfs_feeds(id) ON DELETE CASCADE,
  agency_id TEXT NOT NULL,
  name TEXT NOT NULL,
  url TEXT,
  timezone TEXT NOT NULL DEFAULT 'America/New_York',
  lang TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(feed_id, agency_id)
);
CREATE INDEX idx_agencies_feed ON agencies(feed_id);

CREATE TABLE routes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feed_id UUID NOT NULL REFERENCES gtfs_feeds(id) ON DELETE CASCADE,
  route_id TEXT NOT NULL,
  agency_id TEXT,
  short_name TEXT,
  long_name TEXT,
  type INTEGER NOT NULL DEFAULT 3,
  color TEXT DEFAULT 'FFFFFF',
  text_color TEXT DEFAULT '000000',
  UNIQUE(feed_id, route_id)
);
CREATE INDEX idx_routes_feed ON routes(feed_id);

CREATE TABLE stops (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feed_id UUID NOT NULL REFERENCES gtfs_feeds(id) ON DELETE CASCADE,
  stop_id TEXT NOT NULL,
  name TEXT NOT NULL,
  geometry GEOMETRY(Point, 4326) NOT NULL,
  wheelchair_boarding INTEGER DEFAULT 0,
  UNIQUE(feed_id, stop_id)
);
CREATE INDEX idx_stops_feed ON stops(feed_id);
CREATE INDEX idx_stops_geometry ON stops USING GIST(geometry);

CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feed_id UUID NOT NULL REFERENCES gtfs_feeds(id) ON DELETE CASCADE,
  trip_id TEXT NOT NULL,
  route_id TEXT NOT NULL,
  service_id TEXT NOT NULL,
  headsign TEXT,
  direction_id INTEGER,
  shape_id TEXT,
  UNIQUE(feed_id, trip_id)
);
CREATE INDEX idx_trips_feed ON trips(feed_id);
CREATE INDEX idx_trips_route ON trips(feed_id, route_id);

CREATE TABLE stop_times (
  id BIGSERIAL PRIMARY KEY,
  feed_id UUID NOT NULL REFERENCES gtfs_feeds(id) ON DELETE CASCADE,
  trip_id TEXT NOT NULL,
  stop_id TEXT NOT NULL,
  arrival_time TEXT,
  departure_time TEXT,
  stop_sequence INTEGER NOT NULL
);
CREATE INDEX idx_stop_times_feed ON stop_times(feed_id);
CREATE INDEX idx_stop_times_trip ON stop_times(feed_id, trip_id);
CREATE INDEX idx_stop_times_stop ON stop_times(feed_id, stop_id);

CREATE TABLE shapes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feed_id UUID NOT NULL REFERENCES gtfs_feeds(id) ON DELETE CASCADE,
  shape_id TEXT NOT NULL,
  geometry GEOMETRY(LineString, 4326) NOT NULL,
  UNIQUE(feed_id, shape_id)
);
CREATE INDEX idx_shapes_feed ON shapes(feed_id);
CREATE INDEX idx_shapes_geometry ON shapes USING GIST(geometry);

CREATE TABLE calendar (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feed_id UUID NOT NULL REFERENCES gtfs_feeds(id) ON DELETE CASCADE,
  service_id TEXT NOT NULL,
  monday BOOLEAN NOT NULL DEFAULT false,
  tuesday BOOLEAN NOT NULL DEFAULT false,
  wednesday BOOLEAN NOT NULL DEFAULT false,
  thursday BOOLEAN NOT NULL DEFAULT false,
  friday BOOLEAN NOT NULL DEFAULT false,
  saturday BOOLEAN NOT NULL DEFAULT false,
  sunday BOOLEAN NOT NULL DEFAULT false,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  UNIQUE(feed_id, service_id)
);
CREATE INDEX idx_calendar_feed ON calendar(feed_id);

CREATE TABLE calendar_dates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feed_id UUID NOT NULL REFERENCES gtfs_feeds(id) ON DELETE CASCADE,
  service_id TEXT NOT NULL,
  date DATE NOT NULL,
  exception_type INTEGER NOT NULL
);
CREATE INDEX idx_calendar_dates_feed ON calendar_dates(feed_id);
```

**Step 2: Apply migration**

```bash
pnpm supabase db reset
```

Expected: migration applied, no errors.

**Step 3: Commit**

```bash
git add supabase/migrations/
git commit -m "feat(db): add GTFS schema migrations"
```

---

## Task 4: Database schema — workspaces, analyses, census, LODES

**Files:**
- Create: `supabase/migrations/20260219000002_workspace_schema.sql`
- Create: `supabase/migrations/20260219000003_census_lodes_schema.sql`
- Create: `supabase/migrations/20260219000004_safe_query_fn.sql`

**Step 1: Write workspace migration**

```sql
-- supabase/migrations/20260219000002_workspace_schema.sql

CREATE TABLE workspaces (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  slug TEXT NOT NULL UNIQUE,
  plan TEXT NOT NULL DEFAULT 'free',
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE workspace_members (
  workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  role TEXT NOT NULL DEFAULT 'member',
  joined_at TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (workspace_id, user_id)
);
CREATE INDEX idx_workspace_members_user ON workspace_members(user_id);

CREATE TABLE analyses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID REFERENCES workspaces(id) ON DELETE CASCADE,
  title TEXT NOT NULL DEFAULT 'Untitled Analysis',
  query_text TEXT NOT NULL,
  sql_executed TEXT,
  result_geojson JSONB,
  summary_text TEXT,
  is_public BOOLEAN DEFAULT false,
  share_token TEXT UNIQUE DEFAULT encode(gen_random_bytes(16), 'hex'),
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE INDEX idx_analyses_workspace ON analyses(workspace_id);
CREATE INDEX idx_analyses_share ON analyses(share_token) WHERE is_public = true;

-- RLS
ALTER TABLE workspaces ENABLE ROW LEVEL SECURITY;
ALTER TABLE workspace_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE analyses ENABLE ROW LEVEL SECURITY;
ALTER TABLE gtfs_feeds ENABLE ROW LEVEL SECURITY;

CREATE POLICY "workspace_read" ON workspaces
  FOR SELECT USING (
    id IN (SELECT workspace_id FROM workspace_members WHERE user_id = auth.uid())
  );

CREATE POLICY "members_read" ON workspace_members
  FOR SELECT USING (
    workspace_id IN (SELECT workspace_id FROM workspace_members WHERE user_id = auth.uid())
  );

CREATE POLICY "analyses_read" ON analyses
  FOR SELECT USING (
    is_public = true OR
    workspace_id IN (SELECT workspace_id FROM workspace_members WHERE user_id = auth.uid())
  );

CREATE POLICY "analyses_insert" ON analyses
  FOR INSERT WITH CHECK (
    workspace_id IN (SELECT workspace_id FROM workspace_members WHERE user_id = auth.uid())
  );

CREATE POLICY "analyses_update" ON analyses
  FOR UPDATE USING (
    workspace_id IN (SELECT workspace_id FROM workspace_members WHERE user_id = auth.uid())
  );

-- Add FK from gtfs_feeds to workspaces now that workspaces exists
ALTER TABLE gtfs_feeds ADD CONSTRAINT gtfs_feeds_workspace_fk
  FOREIGN KEY (workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE;

CREATE POLICY "gtfs_feeds_read" ON gtfs_feeds
  FOR SELECT USING (
    workspace_id IS NULL OR
    workspace_id IN (SELECT workspace_id FROM workspace_members WHERE user_id = auth.uid())
  );

CREATE POLICY "gtfs_feeds_insert" ON gtfs_feeds
  FOR INSERT WITH CHECK (
    workspace_id IN (SELECT workspace_id FROM workspace_members WHERE user_id = auth.uid())
  );
```

**Step 2: Write census + LODES migration**

```sql
-- supabase/migrations/20260219000003_census_lodes_schema.sql

CREATE TABLE census_tracts (
  geoid TEXT PRIMARY KEY,
  state_fips TEXT NOT NULL,
  county_fips TEXT NOT NULL,
  name TEXT,
  geometry GEOMETRY(MultiPolygon, 4326) NOT NULL,
  pop_total INTEGER,
  pop_white INTEGER,
  pop_black INTEGER,
  pop_hispanic INTEGER,
  households INTEGER,
  households_zero_vehicle INTEGER,
  median_household_income INTEGER,
  pop_below_poverty INTEGER,
  updated_at TIMESTAMPTZ DEFAULT now()
);
CREATE INDEX idx_census_tracts_state ON census_tracts(state_fips);
CREATE INDEX idx_census_tracts_geom ON census_tracts USING GIST(geometry);

CREATE VIEW census_tracts_computed AS
SELECT *,
  CASE WHEN pop_total > 0
    THEN ROUND(100.0 * (pop_total - pop_white) / pop_total, 1)
  END AS pct_nonwhite,
  CASE WHEN households > 0
    THEN ROUND(100.0 * households_zero_vehicle / households, 1)
  END AS pct_zero_vehicle,
  CASE WHEN pop_total > 0
    THEN ROUND(100.0 * pop_below_poverty / pop_total, 1)
  END AS pct_poverty
FROM census_tracts;

CREATE TABLE lodes_od (
  id BIGSERIAL PRIMARY KEY,
  w_geocode TEXT NOT NULL,
  h_geocode TEXT NOT NULL,
  s000 INTEGER DEFAULT 0,
  sa01 INTEGER DEFAULT 0,
  sa02 INTEGER DEFAULT 0,
  sa03 INTEGER DEFAULT 0,
  se01 INTEGER DEFAULT 0,
  se02 INTEGER DEFAULT 0,
  se03 INTEGER DEFAULT 0,
  year INTEGER NOT NULL,
  state TEXT NOT NULL
);
CREATE INDEX idx_lodes_work ON lodes_od(w_geocode);
CREATE INDEX idx_lodes_home ON lodes_od(h_geocode);
CREATE INDEX idx_lodes_state_year ON lodes_od(state, year);

CREATE VIEW lodes_by_tract AS
SELECT
  SUBSTRING(w_geocode, 1, 11) AS work_tract_geoid,
  SUBSTRING(h_geocode, 1, 11) AS home_tract_geoid,
  SUM(s000) AS total_jobs,
  SUM(sa01) AS jobs_young,
  SUM(sa02) AS jobs_middle,
  SUM(sa03) AS jobs_older,
  SUM(se01) AS jobs_low_wage,
  year,
  state
FROM lodes_od
GROUP BY 1, 2, year, state;
```

**Step 3: Write safe query function**

```sql
-- supabase/migrations/20260219000004_safe_query_fn.sql

CREATE OR REPLACE FUNCTION execute_safe_query(query_text TEXT, p_feed_id UUID DEFAULT NULL)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  result JSONB;
  normalized TEXT;
BEGIN
  normalized := upper(trim(query_text));
  IF NOT (normalized LIKE 'SELECT%') THEN
    RAISE EXCEPTION 'Only SELECT queries allowed';
  END IF;
  IF normalized ~ '(INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|TRUNCATE|GRANT|REVOKE)' THEN
    RAISE EXCEPTION 'Query contains disallowed operation';
  END IF;
  EXECUTE format('SELECT jsonb_agg(row_to_json(t)) FROM (%s) t', query_text)
  INTO result;
  RETURN COALESCE(result, '[]'::jsonb);
END;
$$;

GRANT EXECUTE ON FUNCTION execute_safe_query TO service_role;
```

**Step 4: Write workspace trigger**

```sql
-- supabase/migrations/20260219000005_workspace_trigger.sql

CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  org_name TEXT;
  workspace_slug TEXT;
  new_workspace_id UUID;
BEGIN
  org_name := COALESCE(
    NEW.raw_user_meta_data->>'org_name',
    split_part(NEW.email, '@', 1)
  );
  workspace_slug := lower(regexp_replace(org_name, '[^a-z0-9]', '-', 'g'))
    || '-' || substring(NEW.id::text, 1, 8);

  INSERT INTO workspaces (name, slug)
  VALUES (org_name, workspace_slug)
  RETURNING id INTO new_workspace_id;

  INSERT INTO workspace_members (workspace_id, user_id, role)
  VALUES (new_workspace_id, NEW.id, 'owner');

  RETURN NEW;
END;
$$;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();
```

**Step 5: Write storage migration**

```sql
-- supabase/migrations/20260219000006_storage.sql

INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'gtfs-uploads', 'gtfs-uploads', false, 52428800,
  ARRAY['application/zip', 'application/x-zip-compressed', 'application/octet-stream']
) ON CONFLICT (id) DO NOTHING;

CREATE POLICY "authenticated_upload" ON storage.objects
  FOR INSERT WITH CHECK (
    bucket_id = 'gtfs-uploads' AND auth.uid() IS NOT NULL
  );

CREATE POLICY "authenticated_read" ON storage.objects
  FOR SELECT USING (
    bucket_id = 'gtfs-uploads' AND auth.uid() IS NOT NULL
  );
```

**Step 6: Apply all migrations**

```bash
pnpm supabase db reset
```

Expected: all 6 migrations applied, no errors.

**Step 7: Generate TypeScript types**

```bash
pnpm supabase gen types typescript --local > src/types/supabase.ts
```

**Step 8: Commit**

```bash
git add .
git commit -m "feat(db): add workspace, census, LODES schema and safe query function"
```

---

## Task 5: MapLibre GL map component

**Files:**
- Create: `src/components/map/BaseMap.tsx`
- Create: `src/components/map/GeoJSONLayer.tsx`
- Create: `src/components/map/__tests__/BaseMap.test.tsx`
- Modify: `src/app/globals.css`

**Step 1: Write the failing test**

Create `src/components/map/__tests__/BaseMap.test.tsx`:
```typescript
import { describe, it, expect, vi } from 'vitest'

vi.mock('maplibre-gl', () => ({
  default: {
    Map: vi.fn().mockImplementation(() => ({
      on: vi.fn(),
      remove: vi.fn(),
      addControl: vi.fn(),
    })),
    AttributionControl: vi.fn(),
    NavigationControl: vi.fn(),
  },
}))

describe('BaseMap', () => {
  it('exports a default component', async () => {
    const mod = await import('../BaseMap')
    expect(mod.default).toBeDefined()
    expect(typeof mod.default).toBe('object') // forwardRef returns object
  })

  it('exports DARK_STYLE', async () => {
    const mod = await import('../BaseMap')
    expect(mod.DARK_STYLE).toHaveProperty('version', 8)
  })
})
```

**Step 2: Run test to verify it fails**

```bash
pnpm test
```

Expected: FAIL — module not found

**Step 3: Create BaseMap component**

Add to `src/app/globals.css` (top of file):
```css
@import 'maplibre-gl/dist/maplibre-gl.css';
```

Create `src/components/map/BaseMap.tsx`:
```typescript
'use client'
import { useEffect, useRef, useState, forwardRef, useImperativeHandle } from 'react'
import maplibregl, { Map, type StyleSpecification } from 'maplibre-gl'

export const DARK_STYLE: StyleSpecification = {
  version: 8,
  sources: {
    'osm': {
      type: 'raster',
      tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
      tileSize: 256,
      attribution: '© OpenStreetMap contributors',
    },
  },
  layers: [{ id: 'osm-tiles', type: 'raster', source: 'osm' }],
}

export interface BaseMapHandle {
  getMap: () => Map | null
}

interface BaseMapProps {
  initialCenter?: [number, number]
  initialZoom?: number
  className?: string
  onLoad?: (map: Map) => void
  children?: React.ReactNode
}

const BaseMap = forwardRef<BaseMapHandle, BaseMapProps>(({
  initialCenter = [-98.5795, 39.8283],
  initialZoom = 4,
  className = '',
  onLoad,
  children,
}, ref) => {
  const containerRef = useRef<HTMLDivElement>(null)
  const mapRef = useRef<Map | null>(null)
  const [loaded, setLoaded] = useState(false)

  useImperativeHandle(ref, () => ({
    getMap: () => mapRef.current,
  }))

  useEffect(() => {
    if (!containerRef.current || mapRef.current) return
    const map = new maplibregl.Map({
      container: containerRef.current,
      style: DARK_STYLE,
      center: initialCenter,
      zoom: initialZoom,
      attributionControl: false,
    })
    map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-right')
    map.addControl(new maplibregl.NavigationControl(), 'top-right')
    map.on('load', () => {
      mapRef.current = map
      setLoaded(true)
      onLoad?.(map)
    })
    return () => {
      map.remove()
      mapRef.current = null
    }
  }, []) // eslint-disable-line react-hooks/exhaustive-deps

  return (
    <div className={`relative w-full h-full ${className}`}>
      <div ref={containerRef} className="absolute inset-0" />
      {loaded && children}
    </div>
  )
})

BaseMap.displayName = 'BaseMap'
export default BaseMap
```

**Step 4: Create GeoJSONLayer component**

Create `src/components/map/GeoJSONLayer.tsx`:
```typescript
'use client'
import { useEffect, useId } from 'react'
import type { Map, GeoJSONSource } from 'maplibre-gl'

interface GeoJSONLayerProps {
  map: Map
  geojson: GeoJSON.FeatureCollection
  color?: string
}

export function GeoJSONLayer({ map, geojson, color = '#3b82f6' }: GeoJSONLayerProps) {
  const uid = useId().replace(/:/g, '')
  const sourceId = `src-${uid}`
  const layerId = `lyr-${uid}`
  const outlineId = `out-${uid}`

  useEffect(() => {
    if (!map || !geojson.features.length) return

    if (map.getSource(sourceId)) {
      (map.getSource(sourceId) as GeoJSONSource).setData(geojson)
      return
    }

    map.addSource(sourceId, { type: 'geojson', data: geojson })
    const geomType = geojson.features[0]?.geometry?.type ?? ''

    if (geomType === 'Point' || geomType === 'MultiPoint') {
      map.addLayer({
        id: layerId, type: 'circle', source: sourceId,
        paint: {
          'circle-radius': 6, 'circle-color': color,
          'circle-opacity': 0.85, 'circle-stroke-color': '#fff', 'circle-stroke-width': 1,
        },
      })
    } else if (geomType.includes('Line')) {
      map.addLayer({
        id: layerId, type: 'line', source: sourceId,
        paint: { 'line-color': color, 'line-width': 3, 'line-opacity': 0.9 },
      })
    } else {
      map.addLayer({
        id: layerId, type: 'fill', source: sourceId,
        paint: { 'fill-color': color, 'fill-opacity': 0.3 },
      })
      map.addLayer({
        id: outlineId, type: 'line', source: sourceId,
        paint: { 'line-color': color, 'line-width': 1.5 },
      })
    }

    // Fit bounds to results
    const allCoords: number[][] = []
    geojson.features.forEach(f => {
      if (f.geometry.type === 'Point') allCoords.push(f.geometry.coordinates as number[])
    })
    if (allCoords.length > 0) {
      const lngs = allCoords.map(c => c[0])
      const lats = allCoords.map(c => c[1])
      map.fitBounds(
        [[Math.min(...lngs) - 0.05, Math.min(...lats) - 0.05],
         [Math.max(...lngs) + 0.05, Math.max(...lats) + 0.05]],
        { padding: 60, maxZoom: 14, duration: 800 }
      )
    }

    return () => {
      if (map.getLayer(outlineId)) map.removeLayer(outlineId)
      if (map.getLayer(layerId)) map.removeLayer(layerId)
      if (map.getSource(sourceId)) map.removeSource(sourceId)
    }
  }, [geojson]) // eslint-disable-line react-hooks/exhaustive-deps

  return null
}
```

**Step 5: Run tests to verify they pass**

```bash
pnpm test
```

Expected: PASS (2 tests)

**Step 6: Commit**

```bash
git add .
git commit -m "feat: add MapLibre BaseMap and GeoJSONLayer components"
```

---

## Task 6: AI chat API route and query tool

**Files:**
- Create: `src/lib/ai/system-prompt.ts`
- Create: `src/lib/ai/query-tool.ts`
- Create: `src/app/api/chat/route.ts`

**Step 1: Create system prompt**

Create `src/lib/ai/system-prompt.ts`:
```typescript
export const SYSTEM_PROMPT = `You are OpenPlan AI, a transportation planning assistant with direct access to a PostGIS database containing GTFS transit data, Census tract demographics, and LODES employment data for US cities.

You help planners, advocates, and residents understand transit access and equity through spatial analysis. Answer questions by generating and executing PostGIS SQL queries.

## Database Schema

### GTFS Tables
- \`stops\` (feed_id UUID, stop_id TEXT, name TEXT, geometry POINT WGS84, wheelchair_boarding INT)
- \`routes\` (feed_id UUID, route_id TEXT, short_name TEXT, long_name TEXT, type INT [0=tram,1=subway,2=rail,3=bus,4=ferry], color TEXT)
- \`trips\` (feed_id UUID, trip_id TEXT, route_id TEXT, service_id TEXT, headsign TEXT)
- \`stop_times\` (feed_id UUID, trip_id TEXT, stop_id TEXT, arrival_time TEXT, stop_sequence INT)
- \`shapes\` (feed_id UUID, shape_id TEXT, geometry LINESTRING WGS84)
- \`gtfs_feeds\` (id UUID, city TEXT, state TEXT, agency_name TEXT, status TEXT)

### Census Tables
- \`census_tracts\` (geoid TEXT PK, state_fips TEXT, geometry MULTIPOLYGON WGS84, pop_total INT, households INT, households_zero_vehicle INT, median_household_income INT, pop_below_poverty INT, pop_white INT)
- \`census_tracts_computed\` VIEW adds: pct_nonwhite NUMERIC, pct_zero_vehicle NUMERIC, pct_poverty NUMERIC

### Employment (LODES 8.3, 2022)
- \`lodes_od\` (w_geocode TEXT [work block], h_geocode TEXT [home block], s000 INT [total jobs], year INT, state TEXT)
- \`lodes_by_tract\` VIEW: (work_tract_geoid, home_tract_geoid, total_jobs, year, state)

## PostGIS Spatial Functions
- ST_DWithin(geom_a, geom_b::geography, meters) — true if within distance
- ST_Distance(geom_a::geography, geom_b::geography) — meters
- ST_Buffer(geom::geography, meters)::geometry — buffer zone
- ST_Intersects(geom_a, geom_b) — overlap test
- ST_AsGeoJSON(geom) — geometry as GeoJSON string (ALWAYS include for map display)
- ST_Centroid(geom) — centroid point
- ST_Union(geom) — merge geometries

## Rules
1. ALWAYS call run_spatial_query — never just show SQL
2. ALWAYS include ST_AsGeoJSON(geometry) in SELECT for spatial results
3. Use LIMIT 500 maximum rows
4. SELECT only — no data modification
5. Walking distances: 400m = 5-min walk, 800m = 10-min walk
6. After results, write a plain-English summary of what was found
7. Mention data limitations honestly (LODES is 2022, GTFS varies by agency)
8. If query fails, diagnose and retry with corrected SQL`
```

**Step 2: Create query execution tool**

Create `src/lib/ai/query-tool.ts`:
```typescript
import { createClient } from '@supabase/supabase-js'
import { tool } from 'ai'
import { z } from 'zod'

const BLOCKED_PATTERNS = /\b(INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|TRUNCATE|GRANT|REVOKE)\b/i

function validateSql(sql: string): string | null {
  const trimmed = sql.trim()
  if (!trimmed.toUpperCase().startsWith('SELECT')) return 'Only SELECT queries are allowed'
  if (BLOCKED_PATTERNS.test(trimmed)) return 'Query contains a disallowed operation'
  return null
}

function buildGeoJSON(rows: Record<string, unknown>[]): GeoJSON.FeatureCollection {
  const features: GeoJSON.Feature[] = []
  for (const row of rows) {
    const geomKey = Object.keys(row).find(k =>
      typeof row[k] === 'string' && (row[k] as string).startsWith('{"type"')
    )
    if (!geomKey) continue
    const properties = { ...row }
    delete properties[geomKey]
    try {
      features.push({
        type: 'Feature',
        geometry: JSON.parse(row[geomKey] as string),
        properties,
      })
    } catch {}
  }
  return { type: 'FeatureCollection', features }
}

export function createSpatialQueryTool() {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  )

  return tool({
    description: 'Execute a read-only PostGIS SQL query against transit and census data. Always include ST_AsGeoJSON(geometry) for map display.',
    parameters: z.object({
      sql: z.string().describe('Valid SELECT SQL with ST_AsGeoJSON for any geometry columns. LIMIT 500.'),
      description: z.string().describe('One sentence: what does this query find?'),
    }),
    execute: async ({ sql }) => {
      const validationError = validateSql(sql)
      if (validationError) return { error: validationError, rows: [], rowCount: 0, geojson: null }

      try {
        const { data, error } = await supabase.rpc('execute_safe_query', {
          query_text: sql,
          p_feed_id: null,
        })
        if (error) return { error: error.message, rows: [], rowCount: 0, geojson: null }
        const rows = (data as Record<string, unknown>[]) ?? []
        return {
          rows,
          rowCount: rows.length,
          geojson: buildGeoJSON(rows),
        }
      } catch (e) {
        return { error: String(e), rows: [], rowCount: 0, geojson: null }
      }
    },
  })
}
```

**Step 3: Create API route**

Create `src/app/api/chat/route.ts`:
```typescript
import { streamText } from 'ai'
import { anthropic } from '@ai-sdk/anthropic'
import { SYSTEM_PROMPT } from '@/lib/ai/system-prompt'
import { createSpatialQueryTool } from '@/lib/ai/query-tool'

export const maxDuration = 60

export async function POST(req: Request) {
  const { messages } = await req.json()

  const result = streamText({
    model: anthropic('claude-sonnet-4-6'),
    system: SYSTEM_PROMPT,
    messages,
    tools: {
      run_spatial_query: createSpatialQueryTool(),
    },
    maxSteps: 5,
  })

  return result.toDataStreamResponse()
}
```

**Step 4: Commit**

```bash
git add .
git commit -m "feat: add AI chat API route with spatial query tool"
```

---

## Task 7: AI chat panel UI components

**Files:**
- Create: `src/components/chat/ChatPanel.tsx`
- Create: `src/components/chat/MessageBubble.tsx`
- Create: `src/components/chat/ExampleQueries.tsx`

**Step 1: Create ExampleQueries**

Create `src/components/chat/ExampleQueries.tsx`:
```typescript
const EXAMPLES = [
  'Which census tracts have no transit stop within a 10-minute walk?',
  'Show the top 20 tracts by jobs accessible within 30 min by transit',
  'What % of zero-vehicle households are within 400m of a bus stop?',
  'Which routes serve the most low-income census tracts?',
  'Compare transit stop density between high and low income neighborhoods',
]

export function ExampleQueries({ onSelect }: { onSelect: (q: string) => void }) {
  return (
    <div className="space-y-3 p-4">
      <p className="text-xs text-muted-foreground uppercase tracking-wide font-medium">Try asking</p>
      <div className="flex flex-col gap-1.5">
        {EXAMPLES.map(q => (
          <button
            key={q}
            onClick={() => onSelect(q)}
            className="text-left text-sm px-3 py-2 rounded-md bg-muted hover:bg-muted/70 text-muted-foreground hover:text-foreground transition-colors"
          >
            {q}
          </button>
        ))}
      </div>
    </div>
  )
}
```

**Step 2: Create MessageBubble**

Create `src/components/chat/MessageBubble.tsx`:
```typescript
import type { Message } from 'ai'
import { cn } from '@/lib/utils'

export function MessageBubble({ message }: { message: Message }) {
  const isUser = message.role === 'user'
  return (
    <div className={cn('flex', isUser ? 'justify-end' : 'justify-start')}>
      <div className={cn(
        'max-w-[85%] rounded-lg px-3 py-2 text-sm whitespace-pre-wrap',
        isUser ? 'bg-primary text-primary-foreground' : 'bg-muted text-foreground'
      )}>
        {message.content}
        {message.toolInvocations?.map(tc => (
          tc.state === 'call' ? (
            <div key={tc.toolCallId} className="mt-2 text-xs opacity-60 italic">
              Querying spatial database...
            </div>
          ) : tc.state === 'result' && tc.result?.rowCount != null ? (
            <div key={tc.toolCallId} className="mt-2 text-xs opacity-60">
              ↳ {tc.result.rowCount} features returned
              {tc.result.error && <span className="text-destructive ml-1">({tc.result.error})</span>}
            </div>
          ) : null
        ))}
      </div>
    </div>
  )
}
```

**Step 3: Create ChatPanel**

Create `src/components/chat/ChatPanel.tsx`:
```typescript
'use client'
import { useChat } from 'ai/react'
import { useRef, useEffect, useState } from 'react'
import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'
import { ExampleQueries } from './ExampleQueries'
import { MessageBubble } from './MessageBubble'
import { Send, Loader2 } from 'lucide-react'

interface ChatPanelProps {
  onGeoJSON?: (geojson: GeoJSON.FeatureCollection | null) => void
}

export function ChatPanel({ onGeoJSON }: ChatPanelProps) {
  const [input, setInput] = useState('')
  const bottomRef = useRef<HTMLDivElement>(null)

  const { messages, append, isLoading } = useChat({
    api: '/api/chat',
    onFinish: (message) => {
      for (const tc of (message.toolInvocations ?? [])) {
        if (tc.state === 'result' && tc.result?.geojson?.features?.length > 0) {
          onGeoJSON?.(tc.result.geojson)
          break
        }
      }
    },
  })

  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages])

  const submit = () => {
    if (!input.trim() || isLoading) return
    append({ role: 'user', content: input.trim() })
    setInput('')
  }

  return (
    <div className="flex flex-col h-full">
      <div className="flex-1 overflow-y-auto min-h-0">
        {messages.length === 0
          ? <ExampleQueries onSelect={q => append({ role: 'user', content: q })} />
          : <div className="p-4 space-y-4">
              {messages.map(m => <MessageBubble key={m.id} message={m} />)}
            </div>
        }
        <div ref={bottomRef} />
      </div>
      <form
        onSubmit={e => { e.preventDefault(); submit() }}
        className="p-3 border-t flex gap-2"
      >
        <Textarea
          value={input}
          onChange={e => setInput(e.target.value)}
          onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submit() } }}
          placeholder="Ask about transit access, equity, or mobility..."
          className="resize-none min-h-[52px] max-h-32"
          rows={2}
        />
        <Button type="submit" size="icon" disabled={isLoading || !input.trim()}>
          {isLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : <Send className="h-4 w-4" />}
        </Button>
      </form>
    </div>
  )
}
```

**Step 4: Commit**

```bash
git add .
git commit -m "feat: add AI chat panel with streaming responses"
```

---

## Task 8: Public Explore page

**Files:**
- Create: `src/app/(public)/layout.tsx`
- Create: `src/app/(public)/explore/ExploreClient.tsx`
- Create: `src/app/(public)/explore/page.tsx`

**Step 1: Create public layout**

Create `src/app/(public)/layout.tsx`:
```typescript
export default function PublicLayout({ children }: { children: React.ReactNode }) {
  return <>{children}</>
}
```

**Step 2: Create ExploreClient**

Create `src/app/(public)/explore/ExploreClient.tsx`:
```typescript
'use client'
import { useRef, useState } from 'react'
import BaseMap, { type BaseMapHandle } from '@/components/map/BaseMap'
import { GeoJSONLayer } from '@/components/map/GeoJSONLayer'
import { ChatPanel } from '@/components/chat/ChatPanel'
import type { Map } from 'maplibre-gl'
import Link from 'next/link'

interface ExploreClientProps {
  workspaceFeedId?: string
}

export function ExploreClient({ workspaceFeedId }: ExploreClientProps) {
  const mapRef = useRef<BaseMapHandle>(null)
  const [map, setMap] = useState<Map | null>(null)
  const [resultGeoJSON, setResultGeoJSON] = useState<GeoJSON.FeatureCollection | null>(null)

  return (
    <div className="flex h-screen overflow-hidden bg-background">
      {/* Map */}
      <div className="flex-1 relative min-w-0">
        <BaseMap ref={mapRef} onLoad={setMap} className="absolute inset-0" />
        {map && resultGeoJSON && (
          <GeoJSONLayer map={map} geojson={resultGeoJSON} />
        )}
      </div>

      {/* Chat sidebar */}
      <div className="w-[400px] shrink-0 border-l flex flex-col bg-background">
        <div className="flex items-center justify-between px-4 py-3 border-b shrink-0">
          <div>
            <Link href="/" className="font-bold text-sm">OpenPlan</Link>
            <p className="text-xs text-muted-foreground">AI Transit Analysis</p>
          </div>
          <Link href="/sign-up" className="text-xs text-primary hover:underline">
            Save analyses →
          </Link>
        </div>
        <div className="flex-1 min-h-0">
          <ChatPanel onGeoJSON={setResultGeoJSON} />
        </div>
      </div>
    </div>
  )
}
```

**Step 3: Create explore page**

Create `src/app/(public)/explore/page.tsx`:
```typescript
import type { Metadata } from 'next'
import { ExploreClient } from './ExploreClient'

export const metadata: Metadata = {
  title: 'Explore Transit Data — OpenPlan',
  description: 'Ask AI-powered questions about transit access and equity for any US city. Free, no login required.',
}

export default function ExplorePage() {
  return <ExploreClient />
}
```

**Step 4: Commit**

```bash
git add .
git commit -m "feat: add public Explore page with map and AI chat"
```

---

## Task 9: Landing page and root layout

**Files:**
- Modify: `src/app/layout.tsx`
- Modify: `src/app/page.tsx`

**Step 1: Update root layout**

```typescript
// src/app/layout.tsx
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import './globals.css'
import { Toaster } from '@/components/ui/sonner'

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: 'OpenPlan — Free Transportation Planning Intelligence',
  description: 'AI-powered transit analysis for every agency. Ask questions about transit access and equity — free, open-source, no contract.',
}

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" className="dark">
      <body className={inter.className}>
        {children}
        <Toaster />
      </body>
    </html>
  )
}
```

**Step 2: Write landing page**

```typescript
// src/app/page.tsx
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { ArrowRight, MapPin, BarChart3, Users, Shield } from 'lucide-react'

const EXAMPLES = [
  'Which neighborhoods in Phoenix lost transit access after the 2023 route cuts?',
  'Show census tracts where >30% of households have no car and no nearby bus stop',
  'Compare job accessibility by transit for low-income vs. high-income areas in Chicago',
]

const FEATURES = [
  { icon: MapPin, title: 'Real transit data, 100+ cities', desc: 'Live GTFS feeds from top US agencies, preloaded and queryable instantly.' },
  { icon: BarChart3, title: 'Census & employment data', desc: 'Block-level LODES jobs, ACS demographics, and tract-level equity metrics.' },
  { icon: Users, title: 'Free agency workspaces', desc: 'Upload your own GTFS, save analyses, share with your team. Free forever.' },
  { icon: Shield, title: 'Open source, MIT license', desc: 'Audit it, self-host it, contribute to it. Owned by the community.' },
]

export default function HomePage() {
  return (
    <main className="min-h-screen bg-background">
      <nav className="border-b px-6 py-4 flex items-center justify-between">
        <span className="font-bold text-lg">OpenPlan</span>
        <div className="flex items-center gap-3">
          <Link href="https://github.com/nfredmond/openplan" target="_blank"
            className="text-sm text-muted-foreground hover:text-foreground">GitHub</Link>
          <Button asChild size="sm" variant="outline"><Link href="/sign-in">Sign in</Link></Button>
          <Button asChild size="sm"><Link href="/sign-up">Get started free</Link></Button>
        </div>
      </nav>

      <section className="px-6 py-24 max-w-4xl mx-auto text-center space-y-8">
        <Badge variant="secondary">Free & Open Source — MIT License</Badge>
        <h1 className="text-5xl font-bold tracking-tight leading-tight">
          Transit planning intelligence<br />
          <span className="text-primary">for every agency</span>
        </h1>
        <p className="text-xl text-muted-foreground max-w-2xl mx-auto">
          Ask natural-language questions about transit access and equity.
          Live maps. Instant answers. Powered by real GTFS, Census, and employment data.
          No $50K contract. No login required.
        </p>
        <div className="flex gap-4 justify-center">
          <Button asChild size="lg">
            <Link href="/explore">Try it free <ArrowRight className="ml-2 h-4 w-4" /></Link>
          </Button>
          <Button asChild size="lg" variant="outline">
            <Link href="/sign-up">Create workspace</Link>
          </Button>
        </div>
      </section>

      <section className="px-6 py-12 max-w-3xl mx-auto">
        <p className="text-center text-sm text-muted-foreground mb-6 uppercase tracking-wide font-medium">
          Example questions you can ask right now
        </p>
        <div className="space-y-3">
          {EXAMPLES.map(q => (
            <Link key={q} href={`/explore?q=${encodeURIComponent(q)}`}
              className="block px-5 py-4 rounded-lg border hover:border-primary hover:bg-muted/40 transition-colors text-sm">
              "{q}"
            </Link>
          ))}
        </div>
      </section>

      <section className="px-6 py-16 max-w-5xl mx-auto">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
          {FEATURES.map(({ icon: Icon, title, desc }) => (
            <div key={title} className="flex gap-4">
              <div className="shrink-0 w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                <Icon className="h-5 w-5 text-primary" />
              </div>
              <div>
                <h3 className="font-semibold mb-1">{title}</h3>
                <p className="text-sm text-muted-foreground">{desc}</p>
              </div>
            </div>
          ))}
        </div>
      </section>

      <footer className="border-t px-6 py-8 text-center text-sm text-muted-foreground">
        OpenPlan — free and open-source (MIT). Built for planners, by planners.
      </footer>
    </main>
  )
}
```

**Step 3: Commit**

```bash
git add .
git commit -m "feat: add landing page"
```

---

## Task 10: Auth pages (sign-up and sign-in)

**Files:**
- Create: `src/app/(auth)/layout.tsx`
- Create: `src/app/(auth)/sign-up/page.tsx`
- Create: `src/app/(auth)/sign-in/page.tsx`
- Create: `src/app/auth/callback/route.ts`

**Step 1: Auth layout**

```typescript
// src/app/(auth)/layout.tsx
export default function AuthLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-background px-4">
      {children}
    </div>
  )
}
```

**Step 2: Sign-up page**

```typescript
// src/app/(auth)/sign-up/page.tsx
'use client'
import { useState } from 'react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { createClient } from '@/lib/supabase/client'
import { toast } from 'sonner'

export default function SignUpPage() {
  const router = useRouter()
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [orgName, setOrgName] = useState('')
  const [loading, setLoading] = useState(false)

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    const supabase = createClient()
    const { error } = await supabase.auth.signUp({
      email, password,
      options: { data: { org_name: orgName } },
    })
    if (error) { toast.error(error.message); setLoading(false); return }
    toast.success('Check your email to confirm your account')
    router.push('/sign-in')
  }

  return (
    <div className="w-full max-w-sm space-y-6">
      <div className="text-center">
        <h1 className="text-2xl font-bold">Create your workspace</h1>
        <p className="text-sm text-muted-foreground mt-1">Free forever. No credit card.</p>
      </div>
      <form onSubmit={handleSubmit} className="space-y-4">
        <Input placeholder="Agency or organization name" value={orgName}
          onChange={e => setOrgName(e.target.value)} required />
        <Input type="email" placeholder="Work email" value={email}
          onChange={e => setEmail(e.target.value)} required />
        <Input type="password" placeholder="Password (8+ characters)" value={password}
          onChange={e => setPassword(e.target.value)} minLength={8} required />
        <Button type="submit" className="w-full" disabled={loading}>
          {loading ? 'Creating...' : 'Create free account'}
        </Button>
      </form>
      <p className="text-center text-sm text-muted-foreground">
        Already have an account?{' '}
        <Link href="/sign-in" className="text-primary hover:underline">Sign in</Link>
      </p>
    </div>
  )
}
```

**Step 3: Sign-in page**

```typescript
// src/app/(auth)/sign-in/page.tsx
'use client'
import { useState } from 'react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { createClient } from '@/lib/supabase/client'
import { toast } from 'sonner'

export default function SignInPage() {
  const router = useRouter()
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [loading, setLoading] = useState(false)

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    const supabase = createClient()
    const { error } = await supabase.auth.signInWithPassword({ email, password })
    if (error) { toast.error(error.message); setLoading(false); return }
    router.push('/dashboard')
    router.refresh()
  }

  return (
    <div className="w-full max-w-sm space-y-6">
      <div className="text-center">
        <h1 className="text-2xl font-bold">Welcome back</h1>
        <p className="text-sm text-muted-foreground mt-1">Sign in to your workspace</p>
      </div>
      <form onSubmit={handleSubmit} className="space-y-4">
        <Input type="email" placeholder="Email" value={email}
          onChange={e => setEmail(e.target.value)} required />
        <Input type="password" placeholder="Password" value={password}
          onChange={e => setPassword(e.target.value)} required />
        <Button type="submit" className="w-full" disabled={loading}>
          {loading ? 'Signing in...' : 'Sign in'}
        </Button>
      </form>
      <p className="text-center text-sm text-muted-foreground">
        No account?{' '}
        <Link href="/sign-up" className="text-primary hover:underline">Create one free</Link>
      </p>
    </div>
  )
}
```

**Step 4: Auth callback route**

```typescript
// src/app/auth/callback/route.ts
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  if (code) {
    const supabase = await createClient()
    await supabase.auth.exchangeCodeForSession(code)
  }
  return NextResponse.redirect(`${origin}/dashboard`)
}
```

**Step 5: Commit**

```bash
git add .
git commit -m "feat: add auth pages and session callback"
```

---

## Task 11: Workspace dashboard and map pages

**Files:**
- Create: `src/app/(workspace)/layout.tsx`
- Create: `src/components/nav/WorkspaceNav.tsx`
- Create: `src/app/(workspace)/dashboard/page.tsx`
- Create: `src/app/(workspace)/workspace/[id]/map/page.tsx`
- Create: `src/app/(workspace)/workspace/[id]/data/page.tsx`
- Create: `src/app/(workspace)/workspace/[id]/analyses/page.tsx`

**Step 1: Workspace layout with auth guard**

```typescript
// src/app/(workspace)/layout.tsx
import { redirect } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'
import { WorkspaceNav } from '@/components/nav/WorkspaceNav'

export default async function WorkspaceLayout({ children }: { children: React.ReactNode }) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) redirect('/sign-in')
  return (
    <div className="flex min-h-screen flex-col">
      <WorkspaceNav user={user} />
      <main className="flex-1">{children}</main>
    </div>
  )
}
```

**Step 2: WorkspaceNav**

```typescript
// src/components/nav/WorkspaceNav.tsx
'use client'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { createClient } from '@/lib/supabase/client'
import type { User } from '@supabase/supabase-js'

export function WorkspaceNav({ user }: { user: User }) {
  const router = useRouter()
  const signOut = async () => {
    await createClient().auth.signOut()
    router.push('/')
    router.refresh()
  }
  return (
    <nav className="border-b px-6 py-3 flex items-center justify-between shrink-0">
      <div className="flex items-center gap-6">
        <Link href="/dashboard" className="font-bold">OpenPlan</Link>
        <Link href="/dashboard" className="text-sm text-muted-foreground hover:text-foreground">Dashboard</Link>
        <Link href="/explore" className="text-sm text-muted-foreground hover:text-foreground">Explore</Link>
      </div>
      <div className="flex items-center gap-3">
        <span className="text-sm text-muted-foreground">{user.email}</span>
        <Button size="sm" variant="ghost" onClick={signOut}>Sign out</Button>
      </div>
    </nav>
  )
}
```

**Step 3: Dashboard page**

```typescript
// src/app/(workspace)/dashboard/page.tsx
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import Link from 'next/link'
import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Map, Database, BookOpen } from 'lucide-react'

export default async function DashboardPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) redirect('/sign-in')

  const { data: membership } = await supabase
    .from('workspace_members')
    .select('workspace_id, workspaces(id, name)')
    .eq('user_id', user.id)
    .single()

  if (!membership) redirect('/sign-in')
  const workspace = membership.workspaces as { id: string; name: string }

  const actions = [
    { href: `/workspace/${workspace.id}/map`, icon: Map, title: 'Open Map', desc: 'Ask AI questions, visualize transit data' },
    { href: `/workspace/${workspace.id}/data`, icon: Database, title: 'Manage Data', desc: 'Upload GTFS feeds for your agency' },
    { href: `/workspace/${workspace.id}/analyses`, icon: BookOpen, title: 'Saved Analyses', desc: 'View and share past analyses' },
  ]

  return (
    <div className="max-w-4xl mx-auto px-6 py-12 space-y-8">
      <div>
        <h1 className="text-3xl font-bold">{workspace.name}</h1>
        <p className="text-muted-foreground mt-1">Your transportation planning workspace</p>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {actions.map(({ href, icon: Icon, title, desc }) => (
          <Link key={href} href={href}>
            <Card className="hover:border-primary transition-colors cursor-pointer h-full">
              <CardHeader>
                <Icon className="h-8 w-8 text-primary mb-2" />
                <CardTitle className="text-base">{title}</CardTitle>
                <CardDescription>{desc}</CardDescription>
              </CardHeader>
            </Card>
          </Link>
        ))}
      </div>
    </div>
  )
}
```

**Step 4: Workspace map page**

```typescript
// src/app/(workspace)/workspace/[id]/map/page.tsx
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import { ExploreClient } from '@/app/(public)/explore/ExploreClient'

export default async function WorkspaceMapPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) redirect('/sign-in')

  const { data: member } = await supabase
    .from('workspace_members')
    .select('role')
    .eq('workspace_id', id)
    .eq('user_id', user.id)
    .single()
  if (!member) redirect('/dashboard')

  return <ExploreClient />
}
```

**Step 5: Stub data and analyses pages**

```typescript
// src/app/(workspace)/workspace/[id]/data/page.tsx
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'

export default async function DataPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) redirect('/sign-in')

  const { data: feeds } = await supabase
    .from('gtfs_feeds')
    .select('id, agency_name, status, loaded_at')
    .eq('workspace_id', id)
    .order('created_at', { ascending: false })

  return (
    <div className="max-w-3xl mx-auto px-6 py-12 space-y-6">
      <h1 className="text-2xl font-bold">Data Sources</h1>
      <p className="text-muted-foreground">
        GTFS upload coming soon. For now, use the public Explore mode to query 100+ preloaded US agencies.
      </p>
      {feeds?.map(f => (
        <div key={f.id} className="border rounded-lg p-4">
          <p className="font-medium">{f.agency_name}</p>
          <p className="text-sm text-muted-foreground">Status: {f.status}</p>
        </div>
      ))}
    </div>
  )
}
```

```typescript
// src/app/(workspace)/workspace/[id]/analyses/page.tsx
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import Link from 'next/link'

export default async function AnalysesPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) redirect('/sign-in')

  const { data: analyses } = await supabase
    .from('analyses')
    .select('id, title, query_text, created_at')
    .eq('workspace_id', id)
    .order('created_at', { ascending: false })

  return (
    <div className="max-w-4xl mx-auto px-6 py-12 space-y-6">
      <h1 className="text-2xl font-bold">Saved Analyses</h1>
      {!analyses?.length && (
        <p className="text-muted-foreground">
          No saved analyses yet.{' '}
          <Link href={`/workspace/${id}/map`} className="text-primary hover:underline">
            Open the map to start analyzing.
          </Link>
        </p>
      )}
      {analyses?.map(a => (
        <div key={a.id} className="border rounded-lg p-4">
          <p className="font-medium">{a.title}</p>
          <p className="text-sm text-muted-foreground mt-1">{a.query_text}</p>
          <p className="text-xs text-muted-foreground mt-2">
            {new Date(a.created_at).toLocaleDateString()}
          </p>
        </div>
      ))}
    </div>
  )
}
```

**Step 6: Commit**

```bash
git add .
git commit -m "feat: add workspace dashboard, map, data, and analyses pages"
```

---

## Task 12: GTFS seed script

**Files:**
- Create: `scripts/seed-gtfs.ts`

**Step 1: Write seed script**

```typescript
// scripts/seed-gtfs.ts
// Usage: pnpm seed:gtfs
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
)

const AGENCIES = [
  { city: 'New York', state: 'NY', agency_name: 'MTA NYC Transit', feed_url: 'http://web.mta.info/developers/data/nyct/subway/google_transit.zip' },
  { city: 'Los Angeles', state: 'CA', agency_name: 'LA Metro Bus', feed_url: 'https://gitlab.com/LACMTA/gtfs_bus/-/raw/master/gtfs_bus.zip' },
  { city: 'Chicago', state: 'IL', agency_name: 'Chicago Transit Authority', feed_url: 'https://www.transitchicago.com/downloads/sch_data/google_transit.zip' },
  { city: 'San Francisco', state: 'CA', agency_name: 'SFMTA Muni', feed_url: 'https://gtfs.sfmta.com/transitdata/google_transit.zip' },
  { city: 'Washington DC', state: 'DC', agency_name: 'WMATA', feed_url: 'https://www.wmata.com/schedules/gtfs/google_transit.zip' },
  { city: 'Boston', state: 'MA', agency_name: 'MBTA', feed_url: 'https://cdn.mbta.com/MBTA_GTFS.zip' },
  { city: 'Seattle', state: 'WA', agency_name: 'King County Metro', feed_url: 'https://metro.kingcounty.gov/gtfs/google_transit.zip' },
  { city: 'Atlanta', state: 'GA', agency_name: 'MARTA', feed_url: 'https://www.itsmarta.com/google_transit_feed/google_transit.zip' },
  { city: 'Denver', state: 'CO', agency_name: 'RTD Denver', feed_url: 'https://www.rtd-denver.com/files/gtfs/google_transit.zip' },
  { city: 'Portland', state: 'OR', agency_name: 'TriMet', feed_url: 'https://developer.trimet.org/schedule/gtfs.zip' },
  { city: 'Minneapolis', state: 'MN', agency_name: 'Metro Transit', feed_url: 'https://transitfeeds.com/p/metro-transit/121/latest/download' },
  { city: 'Philadelphia', state: 'PA', agency_name: 'SEPTA', feed_url: 'https://www3.septa.org/developer/gtfs_public.zip' },
  { city: 'Phoenix', state: 'AZ', agency_name: 'Valley Metro', feed_url: 'https://www.valleymetro.org/maps-schedules/developer-resources' },
  { city: 'Miami', state: 'FL', agency_name: 'Miami-Dade Transit', feed_url: 'https://www.miamidade.gov/transit/googlemapdata.asp' },
  { city: 'Houston', state: 'TX', agency_name: 'METRO Houston', feed_url: 'https://www.ridemetro.org/About/Transparency/Open-Data.aspx' },
]

async function main() {
  console.log(`Seeding ${AGENCIES.length} transit agencies...`)
  for (const agency of AGENCIES) {
    const { data, error } = await supabase
      .from('gtfs_feeds')
      .upsert({ ...agency, workspace_id: null, status: 'pending' }, { onConflict: 'city,agency_name' })
      .select()
    if (error) {
      console.error(`✗ ${agency.agency_name}: ${error.message}`)
    } else {
      console.log(`✓ ${agency.agency_name}`)
    }
  }
  console.log('Done. Trigger Edge Function or manual GTFS load to process feeds.')
}

main().catch(console.error)
```

**Step 2: Run it locally**

```bash
pnpm seed:gtfs
```

Expected: 15 agencies inserted, status = pending.

**Step 3: Commit**

```bash
git add scripts/
git commit -m "feat: add GTFS seeding script for top US agencies"
```

---

## Task 13: Open source files and CLAUDE.md update

**Files:**
- Create: `LICENSE`
- Create: `README.md`
- Create: `CONTRIBUTING.md`
- Update: `CLAUDE.md`

**Step 1: Create MIT LICENSE**

```
MIT License

Copyright (c) 2026 OpenPlan Contributors

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction...
[standard MIT text]
```

**Step 2: Update CLAUDE.md** at `/c/Users/nfred/code/Saas.Claude/CLAUDE.md` with commands:

```markdown
## Commands (run from `openplan/` directory)
- `pnpm dev` — start Next.js dev server (localhost:3000)
- `pnpm build` — production build
- `pnpm test` — run vitest unit tests
- `pnpm test:watch` — vitest in watch mode
- `pnpm supabase start` — start local Supabase stack
- `pnpm supabase stop` — stop local Supabase
- `pnpm supabase db reset` — re-apply all migrations from scratch
- `pnpm supabase gen types typescript --local > src/types/supabase.ts` — regenerate DB types
- `pnpm seed:gtfs` — seed top US transit agencies (requires Supabase running)
```

**Step 3: Create README.md** with: project description, one-click Vercel deploy button, local dev quickstart, env vars table, tech stack.

**Step 4: Commit all**

```bash
git add .
git commit -m "chore: add open source files, README, and update CLAUDE.md"
```

---

## Task 14: Vercel deployment

**Step 1: Push to GitHub**

```bash
cd /c/Users/nfred/code/Saas.Claude/openplan
git remote add origin https://github.com/nfredmond/openplan.git
git branch -M main
git push -u origin main
```

**Step 2: Create Supabase project**
- Go to supabase.com → New project → name it `openplan`
- Settings → API: copy URL, anon key, service role key
- Run: `pnpm supabase db push` (pushes local migrations to cloud)

**Step 3: Deploy to Vercel**
- vercel.com → Add New Project → Import `nfredmond/openplan`
- Environment variables: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `ANTHROPIC_API_KEY`
- Deploy

**Step 4: Seed production**

```bash
NEXT_PUBLIC_SUPABASE_URL=<prod> SUPABASE_SERVICE_ROLE_KEY=<prod-key> pnpm seed:gtfs
```

**Step 5: Smoke test**
- Visit `/explore`
- Ask: "Show me all transit stops in Chicago"
- Verify map renders points

---

## Quick Reference

| Command | Purpose |
|---|---|
| `pnpm dev` | Start dev server |
| `pnpm test` | Run unit tests |
| `pnpm supabase start` | Start local Supabase |
| `pnpm supabase db reset` | Reapply all migrations |
| `pnpm supabase gen types typescript --local > src/types/supabase.ts` | Regenerate DB types |
| `pnpm seed:gtfs` | Seed transit agencies |

## Implementation Order Summary

1. Scaffold Next.js project → 2. Supabase setup → 3. GTFS schema → 4. Workspace/census schema → 5. MapLibre components → 6. AI API route → 7. Chat UI → 8. Explore page → 9. Landing page → 10. Auth pages → 11. Workspace pages → 12. Seed script → 13. OSS files → 14. Deploy
